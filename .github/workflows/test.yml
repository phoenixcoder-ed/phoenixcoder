name: ğŸ§ª æ™ºèƒ½åˆ†å±‚æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance
          - security
      test_environment:
        description: 'æµ‹è¯•ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_cache:
        description: 'è·³è¿‡ç¼“å­˜'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.13'
  PNPM_VERSION: '9'
  # æµ‹è¯•ç¯å¢ƒå˜é‡
  CI: true
  NODE_ENV: test
  PYTHONPATH: ${{ github.workspace }}
  # æ•°æ®åº“é…ç½®
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/phoenixcoder_test
  REDIS_URL: redis://localhost:6379/1
  # æµ‹è¯•é…ç½®
  TEST_TIMEOUT: 30000
  COVERAGE_THRESHOLD: 80
  # æ€§èƒ½æµ‹è¯•é…ç½®
  PERFORMANCE_BUDGET_RESPONSE_TIME: 500
  PERFORMANCE_BUDGET_ERROR_RATE: 1
  PERFORMANCE_BUDGET_THROUGHPUT: 100

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ” ESLint æ£€æŸ¥
        run: pnpm run lint
      
      - name: ğŸ¨ Prettier æ£€æŸ¥
        run: pnpm run format:check
      
      - name: ğŸ”§ TypeScript ç±»å‹æ£€æŸ¥
        run: pnpm run type-check
      
      - name: ğŸ”’ å®‰å…¨æ¼æ´æ‰«æ
        run: pnpm audit --audit-level moderate
      
      - name: ğŸ“Š ä»£ç å¤æ‚åº¦åˆ†æ
        run: |
          npx complexity-report --output json --format json src/ > complexity-report.json
          echo "ä»£ç å¤æ‚åº¦æŠ¥å‘Šå·²ç”Ÿæˆ"
      
      - name: ğŸ“¤ ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            complexity-report.json
            eslint-report.json
          retention-days: 7

  # åç«¯å•å…ƒæµ‹è¯•
  backend-unit-tests:
    name: ğŸ åç«¯å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      matrix:
        service: [server, oidc-server, notification-service]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: phoenixcoder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        working-directory: apps/community/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: ğŸ—„ï¸ æ•°æ®åº“è¿ç§»
        working-directory: apps/community/${{ matrix.service }}
        run: |
          python manage.py migrate --settings=config.settings.test
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
      
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: apps/community/${{ matrix.service }}
        run: |
          pytest tests/unit/ \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            --junitxml=test-results.xml \
            --maxfail=5 \
            -v
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: apps/community/${{ matrix.service }}/coverage.xml
          flags: backend-${{ matrix.service }}
          name: backend-${{ matrix.service }}-coverage
          fail_ci_if_error: true
      
      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-${{ matrix.service }}-test-results
          path: |
            apps/community/${{ matrix.service }}/test-results.xml
            apps/community/${{ matrix.service }}/htmlcov/
          retention-days: 7

  # å‰ç«¯å•å…ƒæµ‹è¯•
  frontend-unit-tests:
    name: âš›ï¸ å‰ç«¯å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      matrix:
        app: [admin, mobile]
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: apps/community/${{ matrix.app }}
        run: |
          pnpm test:unit \
            --coverage \
            --reporter=verbose \
            --reporter=junit \
            --outputFile=test-results.xml
        env:
          CI: true
      
      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: apps/community/${{ matrix.app }}/coverage/coverage-final.json
          flags: frontend-${{ matrix.app }}
          name: frontend-${{ matrix.app }}-coverage
          fail_ci_if_error: true
      
      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-${{ matrix.app }}-test-results
          path: |
            apps/community/${{ matrix.app }}/test-results.xml
            apps/community/${{ matrix.app }}/coverage/
          retention-days: 7

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [backend-unit-tests, frontend-unit-tests]
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'integration-test')
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: phoenixcoder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      elasticsearch:
        image: elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 9200:9200
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # å®‰è£… Python ä¾èµ–
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          
          # å®‰è£… Node.js ä¾èµ–
          pnpm install --frozen-lockfile
      
      - name: ğŸ—„ï¸ è®¾ç½®æµ‹è¯•æ•°æ®åº“
        run: |
          python scripts/setup-test-db.py
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸš€ å¯åŠ¨æµ‹è¯•æœåŠ¡
        run: |
          # å¯åŠ¨åç«¯æœåŠ¡
          python apps/community/server/main.py &
          python apps/community/oidc-server/main.py &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 10
          
          # å¥åº·æ£€æŸ¥
          curl -f http://localhost:8000/health
          curl -f http://localhost:8001/health
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          pytest tests/integration/ \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=integration-test-results.xml \
            --maxfail=3 \
            -v
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          API_BASE_URL: http://localhost:8000
          OIDC_BASE_URL: http://localhost:8001
      
      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          flags: integration
          name: integration-coverage
          fail_ci_if_error: false
      
      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-test-results.xml
            htmlcov/
          retention-days: 7

  # E2E æµ‹è¯•
  e2e-tests:
    name: ğŸ­ E2E æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: integration-tests
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'e2e-test')
    
    strategy:
      matrix:
        browser: [chromium, firefox]
        shard: [1, 2, 3, 4]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: phoenixcoder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # å®‰è£… Python ä¾èµ–
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # å®‰è£… Node.js ä¾èµ–
          pnpm install --frozen-lockfile
      
      - name: ğŸ­ å®‰è£… Playwright
        run: |
          pnpm exec playwright install --with-deps ${{ matrix.browser }}
      
      - name: ğŸ—„ï¸ è®¾ç½®æµ‹è¯•æ•°æ®åº“
        run: |
          python scripts/setup-test-db.py
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸš€ å¯åŠ¨åº”ç”¨
        run: |
          # å¯åŠ¨åç«¯æœåŠ¡
          python apps/community/server/main.py &
          python apps/community/oidc-server/main.py &
          
          # æ„å»ºå¹¶å¯åŠ¨å‰ç«¯
          cd apps/community/admin
          pnpm build
          pnpm preview &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 15
          
          # å¥åº·æ£€æŸ¥
          curl -f http://localhost:8000/health
          curl -f http://localhost:3000
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸ§ª è¿è¡Œ E2E æµ‹è¯•
        run: |
          pnpm exec playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }}/4 \
            --reporter=html,junit \
            --output-dir=test-results/${{ matrix.browser }}-shard-${{ matrix.shard }}
        env:
          CI: true
          PLAYWRIGHT_HTML_REPORT: test-results/${{ matrix.browser }}-shard-${{ matrix.shard }}/html-report
      
      - name: ğŸ“¤ ä¸Šä¼  E2E æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: |
            test-results/${{ matrix.browser }}-shard-${{ matrix.shard }}/
            test-results/junit-results.xml
          retention-days: 7
      
      - name: ğŸ“¸ ä¸Šä¼ å¤±è´¥æˆªå›¾
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: test-results/${{ matrix.browser }}-shard-${{ matrix.shard }}/screenshots/
          retention-days: 7

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'performance-test')
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: phoenixcoder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: âš¡ å®‰è£… k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # å®‰è£… Python ä¾èµ–
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # å®‰è£… Node.js ä¾èµ–
          pnpm install --frozen-lockfile
      
      - name: ğŸ—„ï¸ è®¾ç½®æµ‹è¯•æ•°æ®åº“
        run: |
          python scripts/setup-test-db.py --performance
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸš€ å¯åŠ¨åº”ç”¨
        run: |
          # å¯åŠ¨åç«¯æœåŠ¡ (ç”Ÿäº§æ¨¡å¼)
          export NODE_ENV=production
          python apps/community/server/main.py &
          python apps/community/oidc-server/main.py &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 10
          
          # å¥åº·æ£€æŸ¥
          curl -f http://localhost:8000/health
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
      
      - name: ğŸ”¥ è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          cd tests/performance
          chmod +x run-performance-tests.sh
          ./run-performance-tests.sh --type=all --duration=5m --vus=50
        env:
          API_BASE_URL: http://localhost:8000
          FRONTEND_BASE_URL: http://localhost:3000
      
      - name: ğŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: |
          cd tests/performance
          node scripts/generate-report.js --html --json
      
      - name: ğŸ“ˆ æ›´æ–°æ€§èƒ½åŸºå‡†
        if: github.ref == 'refs/heads/main'
        run: |
          cd tests/performance
          node scripts/update-benchmarks.js
          
          # æäº¤åŸºå‡†æ›´æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add benchmarks.json
          git diff --staged --quiet || git commit -m "chore: æ›´æ–°æ€§èƒ½åŸºå‡†