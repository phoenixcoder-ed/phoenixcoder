name: Deploy to Environments

# ÈÉ®ÁΩ≤Ëß¶ÂèëÊù°‰ª∂
on:
  push:
    branches:
      - main        # ÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢É
      - develop     # ÈÉ®ÁΩ≤Âà∞ÊµãËØïÁéØÂ¢É
    tags:
      - 'v*'        # ÁâàÊú¨Ê†áÁ≠æÈÉ®ÁΩ≤
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÈÄâÊã©ÈÉ®ÁΩ≤ÁéØÂ¢É'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'ÈÉ®ÁΩ≤ÁâàÊú¨ (ÂèØÈÄâ)'
        required: false
        type: string

# ÁéØÂ¢ÉÂèòÈáè
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ÊûÑÂª∫DockerÈïúÂÉè
  build-images:
    name: ÊûÑÂª∫DockerÈïúÂÉè
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
      
      - name: ËÆæÁΩÆDocker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ÁôªÂΩïÂÆπÂô®Ê≥®ÂÜåË°®
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ÊèêÂèñÂÖÉÊï∞ÊçÆ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
      
      - name: ÊûÑÂª∫ÂêéÁ´ØÊúçÂä°ÈïúÂÉè
        uses: docker/build-push-action@v5
        with:
          context: ./apps/community/server
          file: ./apps/community/server/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ steps.meta.outputs.version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ÊûÑÂª∫OIDCÊúçÂä°ÈïúÂÉè
        uses: docker/build-push-action@v5
        with:
          context: ./apps/community/oidc-server
          file: ./apps/community/oidc-server/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/oidc-server:${{ steps.meta.outputs.version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ÊûÑÂª∫ÁÆ°ÁêÜÂâçÁ´ØÈïúÂÉè
        uses: docker/build-push-action@v5
        with:
          context: ./apps/community/admin
          file: ./apps/community/admin/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin:${{ steps.meta.outputs.version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ÈÉ®ÁΩ≤Âà∞ÊµãËØïÁéØÂ¢É
  deploy-staging:
    name: ÈÉ®ÁΩ≤Âà∞ÊµãËØïÁéØÂ¢É
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.phoenixcoder.dev
    
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
      
      - name: ËÆæÁΩÆkubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: ÈÖçÁΩÆKubernetes‰∏ä‰∏ãÊñá
        run: |
          echo "${{ secrets.STAGING_KUBECONFIG }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl config current-context
      
      - name: Êõ¥Êñ∞ÈÉ®ÁΩ≤ÈÖçÁΩÆ
        run: |
          export KUBECONFIG=kubeconfig
          
          # Êõ¥Êñ∞ÈïúÂÉèÊ†áÁ≠æ
          sed -i "s|image: .*server:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ needs.build-images.outputs.image-tag }}|g" k8s/staging/server-deployment.yaml
          sed -i "s|image: .*oidc-server:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/oidc-server:${{ needs.build-images.outputs.image-tag }}|g" k8s/staging/oidc-deployment.yaml
          sed -i "s|image: .*admin:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin:${{ needs.build-images.outputs.image-tag }}|g" k8s/staging/admin-deployment.yaml
          
          # Â∫îÁî®ÈÖçÁΩÆ
          kubectl apply -f k8s/staging/
          
          # Á≠âÂæÖÈÉ®ÁΩ≤ÂÆåÊàê
          kubectl rollout status deployment/phoenixcoder-server -n staging --timeout=300s
          kubectl rollout status deployment/phoenixcoder-oidc -n staging --timeout=300s
          kubectl rollout status deployment/phoenixcoder-admin -n staging --timeout=300s
      
      - name: ËøêË°åÈÉ®ÁΩ≤ÂêéÊµãËØï
        run: |
          # Á≠âÂæÖÊúçÂä°Â∞±Áª™
          sleep 30
          
          # ÂÅ•Â∫∑Ê£ÄÊü•
          curl -f https://staging-api.phoenixcoder.dev/health || exit 1
          curl -f https://staging-oidc.phoenixcoder.dev/health || exit 1
          curl -f https://staging.phoenixcoder.dev || exit 1
          
          echo "‚úÖ ÊµãËØïÁéØÂ¢ÉÈÉ®ÁΩ≤ÊàêÂäü"
      
      - name: ÈÄöÁü•ÈÉ®ÁΩ≤Áä∂ÊÄÅ
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ ÊàêÂäü' : '‚ùå Â§±Ë¥•';
            const message = `## üöÄ ÊµãËØïÁéØÂ¢ÉÈÉ®ÁΩ≤ ${status}
            
            **üì¶ ÈÉ®ÁΩ≤‰ø°ÊÅØ**
            - ÁéØÂ¢É: Staging
            - ÁâàÊú¨: ${{ needs.build-images.outputs.image-tag }}
            - Êèê‰∫§: ${{ github.sha }}
            - ÂàÜÊîØ: ${{ github.ref_name }}
            - Êó∂Èó¥: ${new Date().toLocaleString('zh-CN')}
            
            **üîó ËÆøÈóÆÈìæÊé•**
            - ÁÆ°ÁêÜÂêéÂè∞: https://staging.phoenixcoder.dev
            - APIÊúçÂä°: https://staging-api.phoenixcoder.dev
            - OIDCÊúçÂä°: https://staging-oidc.phoenixcoder.dev
            
            **üìã ÈÉ®ÁΩ≤Êó•Âøó**
            Êü•ÁúãËØ¶ÁªÜÊó•Âøó: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            console.log(message);

  # ÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢É
  deploy-production:
    name: ÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢É
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://phoenixcoder.dev
    
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
      
      - name: ËÆæÁΩÆkubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: ÈÖçÁΩÆKubernetes‰∏ä‰∏ãÊñá
        run: |
          echo "${{ secrets.PRODUCTION_KUBECONFIG }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl config current-context
      
      - name: ÂàõÂª∫ÈÉ®ÁΩ≤Â§á‰ªΩ
        run: |
          export KUBECONFIG=kubeconfig
          
          # Â§á‰ªΩÂΩìÂâçÈÉ®ÁΩ≤
          kubectl get deployment phoenixcoder-server -n production -o yaml > backup-server-deployment.yaml
          kubectl get deployment phoenixcoder-oidc -n production -o yaml > backup-oidc-deployment.yaml
          kubectl get deployment phoenixcoder-admin -n production -o yaml > backup-admin-deployment.yaml
      
      - name: ËìùÁªøÈÉ®ÁΩ≤
        run: |
          export KUBECONFIG=kubeconfig
          
          # ÂàõÂª∫Êñ∞ÁâàÊú¨ÈÉ®ÁΩ≤ÔºàÁªøËâ≤ÁéØÂ¢ÉÔºâ
          cp -r k8s/production k8s/production-green
          
          # Êõ¥Êñ∞ÁªøËâ≤ÁéØÂ¢ÉÈïúÂÉèÊ†áÁ≠æ
          sed -i "s|image: .*server:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ needs.build-images.outputs.image-tag }}|g" k8s/production-green/server-deployment.yaml
          sed -i "s|image: .*oidc-server:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/oidc-server:${{ needs.build-images.outputs.image-tag }}|g" k8s/production-green/oidc-deployment.yaml
          sed -i "s|image: .*admin:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin:${{ needs.build-images.outputs.image-tag }}|g" k8s/production-green/admin-deployment.yaml
          
          # Êõ¥Êñ∞ÈÉ®ÁΩ≤ÂêçÁß∞ÔºàÊ∑ªÂä†-greenÂêéÁºÄÔºâ
          sed -i 's/name: phoenixcoder-/name: phoenixcoder-green-/g' k8s/production-green/*-deployment.yaml
          
          # ÈÉ®ÁΩ≤ÁªøËâ≤ÁéØÂ¢É
          kubectl apply -f k8s/production-green/
          
          # Á≠âÂæÖÁªøËâ≤ÁéØÂ¢ÉÂ∞±Áª™
          kubectl rollout status deployment/phoenixcoder-green-server -n production --timeout=600s
          kubectl rollout status deployment/phoenixcoder-green-oidc -n production --timeout=600s
          kubectl rollout status deployment/phoenixcoder-green-admin -n production --timeout=600s
      
      - name: ÂÅ•Â∫∑Ê£ÄÊü•
        run: |
          export KUBECONFIG=kubeconfig
          
          # Ëé∑ÂèñÁªøËâ≤ÁéØÂ¢ÉÊúçÂä°IP
          GREEN_SERVER_IP=$(kubectl get svc phoenixcoder-green-server -n production -o jsonpath='{.spec.clusterIP}')
          GREEN_OIDC_IP=$(kubectl get svc phoenixcoder-green-oidc -n production -o jsonpath='{.spec.clusterIP}')
          GREEN_ADMIN_IP=$(kubectl get svc phoenixcoder-green-admin -n production -o jsonpath='{.spec.clusterIP}')
          
          # ÂÅ•Â∫∑Ê£ÄÊü•
          kubectl run health-check --rm -i --restart=Never --image=curlimages/curl -- \
            sh -c "curl -f http://$GREEN_SERVER_IP:8000/health && curl -f http://$GREEN_OIDC_IP:8080/health"
          
          echo "‚úÖ ÁªøËâ≤ÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá"
      
      - name: ÂàáÊç¢ÊµÅÈáè
        run: |
          export KUBECONFIG=kubeconfig
          
          # Êõ¥Êñ∞ÊúçÂä°ÈÄâÊã©Âô®ÔºåÂ∞ÜÊµÅÈáèÂàáÊç¢Âà∞ÁªøËâ≤ÁéØÂ¢É
          kubectl patch service phoenixcoder-server -n production -p '{"spec":{"selector":{"app":"phoenixcoder-green-server"}}}'
          kubectl patch service phoenixcoder-oidc -n production -p '{"spec":{"selector":{"app":"phoenixcoder-green-oidc"}}}'
          kubectl patch service phoenixcoder-admin -n production -p '{"spec":{"selector":{"app":"phoenixcoder-green-admin"}}}'
          
          echo "‚úÖ ÊµÅÈáèÂ∑≤ÂàáÊç¢Âà∞Êñ∞ÁâàÊú¨"
      
      - name: È™åËØÅÈÉ®ÁΩ≤
        run: |
          # Á≠âÂæÖDNS‰º†Êí≠
          sleep 60
          
          # È™åËØÅÁîü‰∫ßÁéØÂ¢É
          curl -f https://api.phoenixcoder.dev/health || exit 1
          curl -f https://oidc.phoenixcoder.dev/health || exit 1
          curl -f https://phoenixcoder.dev || exit 1
          
          echo "‚úÖ Áîü‰∫ßÁéØÂ¢ÉÈ™åËØÅÊàêÂäü"
      
      - name: Ê∏ÖÁêÜÊóßÁâàÊú¨
        if: success()
        run: |
          export KUBECONFIG=kubeconfig
          
          # Âà†Èô§ËìùËâ≤ÁéØÂ¢ÉÔºàÊóßÁâàÊú¨Ôºâ
          kubectl delete deployment phoenixcoder-server -n production --ignore-not-found=true
          kubectl delete deployment phoenixcoder-oidc -n production --ignore-not-found=true
          kubectl delete deployment phoenixcoder-admin -n production --ignore-not-found=true
          
          # ÈáçÂëΩÂêçÁªøËâ≤ÁéØÂ¢É‰∏∫Ê≠£ÂºèÁéØÂ¢É
          kubectl patch deployment phoenixcoder-green-server -n production -p '{"metadata":{"name":"phoenixcoder-server"}}'
          kubectl patch deployment phoenixcoder-green-oidc -n production -p '{"metadata":{"name":"phoenixcoder-oidc"}}'
          kubectl patch deployment phoenixcoder-green-admin -n production -p '{"metadata":{"name":"phoenixcoder-admin"}}'
          
          echo "‚úÖ ÈÉ®ÁΩ≤Ê∏ÖÁêÜÂÆåÊàê"
      
      - name: ÂõûÊªöÈÉ®ÁΩ≤
        if: failure()
        run: |
          export KUBECONFIG=kubeconfig
          
          echo "‚ùå ÈÉ®ÁΩ≤Â§±Ë¥•ÔºåÂºÄÂßãÂõûÊªö..."
          
          # ÊÅ¢Â§çÊúçÂä°ÈÄâÊã©Âô®
          kubectl patch service phoenixcoder-server -n production -p '{"spec":{"selector":{"app":"phoenixcoder-server"}}}'
          kubectl patch service phoenixcoder-oidc -n production -p '{"spec":{"selector":{"app":"phoenixcoder-oidc"}}}'
          kubectl patch service phoenixcoder-admin -n production -p '{"spec":{"selector":{"app":"phoenixcoder-admin"}}}'
          
          # Âà†Èô§Â§±Ë¥•ÁöÑÁªøËâ≤ÁéØÂ¢É
          kubectl delete deployment phoenixcoder-green-server -n production --ignore-not-found=true
          kubectl delete deployment phoenixcoder-green-oidc -n production --ignore-not-found=true
          kubectl delete deployment phoenixcoder-green-admin -n production --ignore-not-found=true
          
          echo "‚úÖ ÂõûÊªöÂÆåÊàê"
      
      - name: ÈÄöÁü•ÈÉ®ÁΩ≤Áä∂ÊÄÅ
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ ÊàêÂäü' : '‚ùå Â§±Ë¥•';
            const message = `## üöÄ Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤ ${status}
            
            **üì¶ ÈÉ®ÁΩ≤‰ø°ÊÅØ**
            - ÁéØÂ¢É: Production
            - ÁâàÊú¨: ${{ needs.build-images.outputs.image-tag }}
            - Êèê‰∫§: ${{ github.sha }}
            - ÂàÜÊîØ: ${{ github.ref_name }}
            - Êó∂Èó¥: ${new Date().toLocaleString('zh-CN')}
            - ÈÉ®ÁΩ≤Á≠ñÁï•: ËìùÁªøÈÉ®ÁΩ≤
            
            **üîó ËÆøÈóÆÈìæÊé•**
            - ÂÆòÊñπÁΩëÁ´ô: https://phoenixcoder.dev
            - APIÊúçÂä°: https://api.phoenixcoder.dev
            - OIDCÊúçÂä°: https://oidc.phoenixcoder.dev
            
            **üìã ÈÉ®ÁΩ≤Êó•Âøó**
            Êü•ÁúãËØ¶ÁªÜÊó•Âøó: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            console.log(message);

  # ÈÉ®ÁΩ≤ÂêéÁõëÊéß
  post-deploy-monitoring:
    name: ÈÉ®ÁΩ≤ÂêéÁõëÊéß
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
      - name: ËÆæÁΩÆÁõëÊéß
        run: |
          echo "üîç ÂºÄÂßãÈÉ®ÁΩ≤ÂêéÁõëÊéß..."
          
          # Á°ÆÂÆöÁõëÊéßÁéØÂ¢É
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            ENVIRONMENT="production"
            BASE_URL="https://phoenixcoder.dev"
          else
            ENVIRONMENT="staging"
            BASE_URL="https://staging.phoenixcoder.dev"
          fi
          
          echo "ÁõëÊéßÁéØÂ¢É: $ENVIRONMENT"
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
      
      - name: ÊÄßËÉΩÁõëÊéß
        run: |
          echo "üìä ËøêË°åÊÄßËÉΩÁõëÊéß..."
          
          # ÂìçÂ∫îÊó∂Èó¥Ê£ÄÊü•
          for i in {1..5}; do
            echo "Á¨¨ $i Ê¨°Ê£ÄÊü•..."
            
            # APIÂìçÂ∫îÊó∂Èó¥
            API_TIME=$(curl -o /dev/null -s -w "%{time_total}" $BASE_URL/api/health)
            echo "APIÂìçÂ∫îÊó∂Èó¥: ${API_TIME}s"
            
            # ÂâçÁ´ØÂä†ËΩΩÊó∂Èó¥
            FRONTEND_TIME=$(curl -o /dev/null -s -w "%{time_total}" $BASE_URL)
            echo "ÂâçÁ´ØÂä†ËΩΩÊó∂Èó¥: ${FRONTEND_TIME}s"
            
            # Ê£ÄÊü•ÂìçÂ∫îÊó∂Èó¥ÊòØÂê¶Âú®ÂèØÊé•ÂèóËåÉÂõ¥ÂÜÖ
            if (( $(echo "$API_TIME > 2.0" | bc -l) )); then
              echo "‚ö†Ô∏è APIÂìçÂ∫îÊó∂Èó¥ËøáÈïø: ${API_TIME}s"
            fi
            
            if (( $(echo "$FRONTEND_TIME > 3.0" | bc -l) )); then
              echo "‚ö†Ô∏è ÂâçÁ´ØÂä†ËΩΩÊó∂Èó¥ËøáÈïø: ${FRONTEND_TIME}s"
            fi
            
            sleep 30
          done
      
      - name: ÈîôËØØÁéáÁõëÊéß
        run: |
          echo "üö® Ê£ÄÊü•ÈîôËØØÁéá..."
          
          # Ê®°Êãü‰∏Ä‰∫õËØ∑Ê±ÇÊù•Ê£ÄÊü•ÈîôËØØÁéá
          SUCCESS_COUNT=0
          TOTAL_COUNT=20
          
          for i in $(seq 1 $TOTAL_COUNT); do
            if curl -f -s $BASE_URL/api/health > /dev/null; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            sleep 1
          done
          
          SUCCESS_RATE=$(echo "scale=2; $SUCCESS_COUNT * 100 / $TOTAL_COUNT" | bc)
          echo "ÊàêÂäüÁéá: ${SUCCESS_RATE}%"
          
          if (( $(echo "$SUCCESS_RATE < 95" | bc -l) )); then
            echo "‚ùå ÈîôËØØÁéáËøáÈ´òÔºåÊàêÂäüÁéá‰ªÖ‰∏∫ ${SUCCESS_RATE}%"
            exit 1
          else
            echo "‚úÖ ÈîôËØØÁéáÊ≠£Â∏∏ÔºåÊàêÂäüÁéá‰∏∫ ${SUCCESS_RATE}%"
          fi
      
      - name: ÁîüÊàêÁõëÊéßÊä•Âëä
        if: always()
        run: |
          echo "üìã ÁîüÊàêÁõëÊéßÊä•Âëä..."
          
          cat > monitoring-report.md << EOF
          # ÈÉ®ÁΩ≤ÂêéÁõëÊéßÊä•Âëä
          
          **ÁéØÂ¢É**: $ENVIRONMENT  
          **Êó∂Èó¥**: $(date)  
          **Áä∂ÊÄÅ**: ${{ job.status }}
          
          ## ÁõëÊéßÁªìÊûú
          
          - ‚úÖ ÊúçÂä°ÂèØÁî®ÊÄßÊ£ÄÊü•
          - ‚úÖ ÂìçÂ∫îÊó∂Èó¥ÁõëÊéß
          - ‚úÖ ÈîôËØØÁéáÊ£ÄÊü•
          
          ## Âª∫ËÆÆ
          
          - ÁªßÁª≠ÁõëÊéßÊúçÂä°ÊÄßËÉΩ
          - ÂÖ≥Ê≥®Áî®Êà∑ÂèçÈ¶à
          - ÂÆöÊúüÊ£ÄÊü•Êó•Âøó
          
          EOF
          
          echo "‚úÖ ÁõëÊéßÊä•ÂëäÁîüÊàêÂÆåÊàê"
      
      - name: ‰∏ä‰º†ÁõëÊéßÊä•Âëä
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: monitoring-report-${{ env.ENVIRONMENT }}
          path: monitoring-report.md