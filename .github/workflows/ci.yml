name: PhoenixCoder CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•
    - cron: '0 2 * * *'

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '8'

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black isort flake8 bandit mypy
      
      - name: è¿è¡Œpre-commitæ£€æŸ¥
        run: |
          pre-commit install
          pre-commit run --all-files
      
      - name: ä»£ç å¤æ‚åº¦æ£€æŸ¥
        run: |
          pip install radon
          radon cc --min=C apps/community/server apps/community/oidc-server
      
      - name: å®‰å…¨æ¼æ´æ‰«æ
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
      
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: safety-report.json

  # åç«¯æµ‹è¯•
  backend-tests:
    name: åç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [server, oidc-server]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        working-directory: apps/community/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: apps/community/${{ matrix.service }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          TESTING: true
        run: |
          python -m pytest tests/ \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --junitxml=test-results.xml \
            --tb=short \
            -v
      
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        working-directory: apps/community/${{ matrix.service }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          TESTING: true
        run: |
          python -m pytest tests/performance/ \
            --benchmark-json=benchmark-results.json \
            --benchmark-only
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: apps/community/${{ matrix.service }}/coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage
      
      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ matrix.service }}-test-results
          path: |
            apps/community/${{ matrix.service }}/test-results.xml
            apps/community/${{ matrix.service }}/htmlcov/
            apps/community/${{ matrix.service }}/benchmark-results.json

  # å‰ç«¯æµ‹è¯•
  frontend-tests:
    name: å‰ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [admin, miniapp]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm install --frozen-lockfile
      
      - name: ç±»å‹æ£€æŸ¥
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm run type-check
      
      - name: ä»£ç æ£€æŸ¥
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm run lint
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: apps/community/${{ matrix.app }}
        run: |
          pnpm run test:unit \
            --coverage \
            --reporter=verbose \
            --reporter=junit \
            --outputFile=test-results.xml
      
      - name: è¿è¡Œç»„ä»¶æµ‹è¯•
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm run test:component --coverage
      
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm run test:performance
      
      - name: æ„å»ºæ£€æŸ¥
        working-directory: apps/community/${{ matrix.app }}
        run: pnpm run build
      
      - name: Bundleåˆ†æ
        working-directory: apps/community/${{ matrix.app }}
        run: |
          pnpm run build:analyze
          ls -la dist/
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: apps/community/${{ matrix.app }}/coverage/lcov.info
          flags: ${{ matrix.app }}
          name: ${{ matrix.app }}-coverage
      
      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ matrix.app }}-test-results
          path: |
            apps/community/${{ matrix.app }}/test-results.xml
            apps/community/${{ matrix.app }}/coverage/
            apps/community/${{ matrix.app }}/dist/

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: å®‰è£…åç«¯ä¾èµ–
        working-directory: apps/community/server
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: apps/community/admin
        run: pnpm install --frozen-lockfile
      
      - name: å¯åŠ¨åç«¯æœåŠ¡
        working-directory: apps/community/server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          TESTING: true
        run: |
          python main.py &
          sleep 10
      
      - name: æ„å»ºå‰ç«¯
        working-directory: apps/community/admin
        run: pnpm run build
      
      - name: å®‰è£…Playwright
        working-directory: apps/community/admin
        run: pnpm exec playwright install --with-deps
      
      - name: è¿è¡ŒE2Eæµ‹è¯•
        working-directory: apps/community/admin
        run: pnpm run test:e2e
      
      - name: ä¸Šä¼ E2Eæµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            apps/community/admin/test-results/
            apps/community/admin/playwright-report/

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          TESTING: true
        run: |
          python -m pytest tests/ \
            --cov=apps \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=integration-test-results.xml \
            --tb=short \
            -v
      
      - name: ä¸Šä¼ é›†æˆæµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-test-results.xml
            htmlcov/
            coverage.xml

  # è¦†ç›–ç‡æ±‡æ€»
  coverage-report:
    name: è¦†ç›–ç‡æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v3
      
      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          node coverage-monitor.js --generate-report
          node coverage-badge-generator.js --generate-all
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage-reports/
            badges/
      
      - name: è¯„è®ºPRè¦†ç›–ç‡
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'coverage-reports/summary.json';
            
            if (fs.existsSync(path)) {
              const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
              
              const comment = `## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
              
              | é¡¹ç›® | è¡Œè¦†ç›–ç‡ | åˆ†æ”¯è¦†ç›–ç‡ | å‡½æ•°è¦†ç›–ç‡ |
              |------|----------|------------|------------|
              | åç«¯æœåŠ¡ | ${coverage.server?.lines || 'N/A'}% | ${coverage.server?.branches || 'N/A'}% | ${coverage.server?.functions || 'N/A'}% |
              | OIDCæœåŠ¡ | ${coverage.oidc?.lines || 'N/A'}% | ${coverage.oidc?.branches || 'N/A'}% | ${coverage.oidc?.functions || 'N/A'}% |
              | ç®¡ç†å‰ç«¯ | ${coverage.admin?.lines || 'N/A'}% | ${coverage.admin?.branches || 'N/A'}% | ${coverage.admin?.functions || 'N/A'}% |
              | å°ç¨‹åº | ${coverage.miniapp?.lines || 'N/A'}% | ${coverage.miniapp?.branches || 'N/A'}% | ${coverage.miniapp?.functions || 'N/A'}% |
              
              ğŸ“ˆ [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # æ€§èƒ½å›å½’æ£€æµ‹
  performance-regression:
    name: æ€§èƒ½å›å½’æ£€æµ‹
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ä¸‹è½½æ€§èƒ½æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v3
        with:
          pattern: '*-test-results'
      
      - name: è¿è¡Œæ€§èƒ½å›å½’æ£€æµ‹
        run: |
          node performance-regression-detector.js \
            --compare-with=main \
            --threshold=10 \
            --output=performance-report.json
      
      - name: è¯„è®ºPRæ€§èƒ½æŠ¥å‘Š
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'performance-report.json';
            
            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              
              if (report.regressions && report.regressions.length > 0) {
                const comment = `## âš ï¸ æ€§èƒ½å›å½’æ£€æµ‹
                
                å‘ç° ${report.regressions.length} ä¸ªæ€§èƒ½å›å½’é—®é¢˜ï¼š
                
                ${report.regressions.map(r => 
                  `- **${r.metric}**: ${r.change}% å˜åŒ– (é˜ˆå€¼: ${r.threshold}%)`
                ).join('\n')}
                
                è¯·æ£€æŸ¥ä»£ç å˜æ›´å¯¹æ€§èƒ½çš„å½±å“ã€‚`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

  # éƒ¨ç½²æ£€æŸ¥
  deployment-check:
    name: éƒ¨ç½²æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, backend-tests, frontend-tests, e2e-tests, integration-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: æ£€æŸ¥éƒ¨ç½²é…ç½®
        run: |
          echo "æ£€æŸ¥Dockeré…ç½®..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose config
          fi
          
          echo "æ£€æŸ¥Kubernetesé…ç½®..."
          if [ -d "k8s" ]; then
            kubectl --dry-run=client apply -f k8s/ || true
          fi
      
      - name: å®‰å…¨æ‰«æ
        run: |
          echo "è¿è¡Œå®‰å…¨æ‰«æ..."
          # è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤šå®‰å…¨æ‰«æå·¥å…·
      
      - name: éƒ¨ç½²å°±ç»ªæ£€æŸ¥
        run: |
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²"
          echo "deployment_ready=true" >> $GITHUB_OUTPUT
        id: deployment
      
      - name: é€šçŸ¥éƒ¨ç½²çŠ¶æ€
        if: steps.deployment.outputs.deployment_ready == 'true'
        run: |
          echo "ğŸš€ é¡¹ç›®å·²å‡†å¤‡å¥½éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"