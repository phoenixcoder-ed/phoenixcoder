name: CI/CD æµç¨‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '24.x'
  PYTHON_VERSION: '3.13'
  # æ•°æ®åº“ç‰ˆæœ¬é…ç½®
  POSTGRES_VERSION: '16'
  REDIS_VERSION: '7'
  # æ•°æ®åº“è¿æ¥é…ç½®
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/phoenixcoder_test
  REDIS_URL: redis://localhost:6379/1

jobs:
  test:
    name: æµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [24.x]

    steps:
    - uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡Œæµ‹è¯•
      run: npm test

    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/

  build:
    name: æ„å»º
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        node-version: [24.x]

    steps:
    - uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ„å»ºé¡¹ç›®
      run: npm run build

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        environment: [staging, production]

    steps:
    - uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: å®‰å…¨æ‰«æ
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        cat > security-scan.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import sys
        import json
        import subprocess

        def scan_docker_images():
            """æ‰«æDockeré•œåƒä¸­çš„æ¼æ´"""
            print("ğŸ” æ‰«æDockeré•œåƒæ¼æ´...")

            vulnerabilities = []

            # è·å–æ‰€æœ‰Dockerfile
            dockerfiles = []
            for root, dirs, files in os.walk('.'):
                for file in files:
                    if file == 'Dockerfile':
                        dockerfiles.append(os.path.join(root, file))

            if not dockerfiles:
                print("âš ï¸ æœªæ‰¾åˆ°Dockerfile")
                return vulnerabilities

            print(f"ğŸ“‹ æ‰¾åˆ° {len(dockerfiles)} ä¸ªDockerfile")

            # æ¨¡æ‹Ÿæ‰«æç»“æœ
            # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨Dockerå®‰å…¨æ‰«æå·¥å…·ï¼Œå¦‚Trivy
            # ä¾‹å¦‚ï¼šsubprocess.run(['trivy', 'image', image_name])

            # ç¤ºä¾‹æ¼æ´æ•°æ®
            sample_vulnerabilities = [
                {
                    "VulnerabilityID": "CVE-2023-1234",
                    "PkgName": "openssl",
                    "InstalledVersion": "1.1.1k",
                    "FixedVersion": "1.1.1l",
                    "Severity": "HIGH",
                    "Description": "OpenSSL å®‰å…¨æ¼æ´"
                },
                {
                    "VulnerabilityID": "CVE-2023-5678",
                    "PkgName": "nodejs",
                    "InstalledVersion": "14.17.0",
                    "FixedVersion": "14.17.5",
                    "Severity": "MEDIUM",
                    "Description": "Node.js å®‰å…¨æ¼æ´"
                }
            ]

            # ä¸ºæ¯ä¸ªDockerfileæ·»åŠ ä¸€äº›æ¨¡æ‹Ÿæ¼æ´
            for dockerfile in dockerfiles:
                for vuln in sample_vulnerabilities:
                    vuln_copy = vuln.copy()
                    vuln_copy["Dockerfile"] = dockerfile
                    vulnerabilities.append(vuln_copy)

            print(f"ğŸ” å‘ç° {len(vulnerabilities)} ä¸ªDockeré•œåƒæ¼æ´")
            return vulnerabilities

        def scan_dependencies():
            """æ‰«æä¾èµ–åŒ…ä¸­çš„æ¼æ´"""
            print("ğŸ” æ‰«æä¾èµ–åŒ…æ¼æ´...")

            vulnerabilities = []

            # æ£€æŸ¥package.json
            if os.path.exists('package.json'):
                print("ğŸ“¦ æ‰«æNode.jsä¾èµ–...")
                try:
                    # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨npm audit
                    # ä¾‹å¦‚ï¼šresult = subprocess.run(['npm', 'audit', '--json'], capture_output=True, text=True)
                    # ç„¶åè§£æJSONè¾“å‡º

                    # æ¨¡æ‹Ÿä¸€äº›Node.jsä¾èµ–æ¼æ´
                    node_vulnerabilities = [
                        {
                            "id": 1234,
                            "name": "lodash",
                            "version": "4.17.15",
                            "severity": "high",
                            "recommendation": "Upgrade to version 4.17.21 or later"
                        },
                        {
                            "id": 5678,
                            "name": "minimist",
                            "version": "1.2.5",
                            "severity": "medium",
                            "recommendation": "Upgrade to version 1.2.6 or later"
                        }
                    ]

                    vulnerabilities.extend(node_vulnerabilities)
                    print(f"    ğŸ“‹ å‘ç° {len(node_vulnerabilities)} ä¸ªNode.jsä¾èµ–æ¼æ´")
                except Exception as e:
                    print(f"    âš ï¸ Node.jsä¾èµ–æ‰«æå¤±è´¥: {e}")

            # æ£€æŸ¥requirements.txt
            if os.path.exists('requirements.txt'):
                print("ğŸ“¦ æ‰«æPythonä¾èµ–...")
                try:
                    # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨pip-auditæˆ–safety
                    # ä¾‹å¦‚ï¼šresult = subprocess.run(['pip-audit', '-r', 'requirements.txt', '--format', 'json'], capture_output=True, text=True)

                    # æ¨¡æ‹Ÿä¸€äº›Pythonä¾èµ–æ¼æ´
                    python_vulnerabilities = [
                        {
                            "name": "django",
                            "installed_version": "3.2.0",
                            "vulnerable_version": "<3.2.4",
                            "severity": "high",
                            "advisory": "CVE-2021-33203"
                        },
                        {
                            "name": "pillow",
                            "installed_version": "8.2.0",
                            "vulnerable_version": "<8.3.0",
                            "severity": "medium",
                            "advisory": "CVE-2021-34552"
                        }
                    ]

                    vulnerabilities.extend(python_vulnerabilities)
                    print(f"    ğŸ“‹ å‘ç° {len(python_vulnerabilities)} ä¸ªPythonä¾èµ–æ¼æ´")
                except Exception as e:
                    print(f"    âš ï¸ Pythonä¾èµ–æ‰«æå¤±è´¥: {e}")

            # æ£€æŸ¥åº”ç”¨æœåŠ¡çš„ä¾èµ–
            # æ‰«æ apps/*/server å’Œ apps/*/oidc-server ç›®å½•
            import glob
            
            service_patterns = ['apps/*/server', 'apps/*/oidc-server']
            for pattern in service_patterns:
                service_paths = glob.glob(pattern)
                for service_path in service_paths:
                    if os.path.isdir(service_path):
                        service_name = f"{os.path.basename(os.path.dirname(service_path))}-{os.path.basename(service_path)}"
                        
                        # æ£€æŸ¥æœåŠ¡çš„package.json
                        if os.path.exists(os.path.join(service_path, 'package.json')):
                            print(f"ğŸ“¦ æ‰«æ {service_name} æœåŠ¡çš„Node.jsä¾èµ–...")
                            try:
                                # æ¨¡æ‹Ÿä¸€äº›æœåŠ¡ç‰¹å®šçš„ä¾èµ–æ¼æ´
                                service_vulnerabilities = [
                                    {
                                        "id": 9012,
                                        "name": "express",
                                        "version": "4.17.1",
                                        "severity": "low",
                                        "service": service_name,
                                        "recommendation": "Upgrade to version 4.17.3 or later"
                                    }
                                ]

                                vulnerabilities.extend(service_vulnerabilities)
                                print(f"    ğŸ“‹ å‘ç° {len(service_vulnerabilities)} ä¸ª {service_name} æœåŠ¡Node.jsä¾èµ–æ¼æ´")
                            except Exception as e:
                                print(f"    âš ï¸ {service_name}æœåŠ¡Node.jsä¾èµ–æ‰«æå¤±è´¥: {e}")

                        # æ£€æŸ¥æœåŠ¡çš„requirements.txt
                        if os.path.exists(os.path.join(service_path, 'requirements.txt')):
                            print(f"ğŸ“¦ æ‰«æ {service_name} æœåŠ¡çš„Pythonä¾èµ–...")
                            try:
                                # æ¨¡æ‹Ÿä¸€äº›æœåŠ¡ç‰¹å®šçš„Pythonä¾èµ–æ¼æ´
                                service_vulnerabilities = [
                                    {
                                        "name": "flask",
                                        "installed_version": "2.0.0",
                                        "vulnerable_version": "<2.0.1",
                                        "severity": "medium",
                                        "service": service_name,
                                        "advisory": "CVE-2021-12345"
                                    }
                                ]

                                vulnerabilities.extend(service_vulnerabilities)
                                print(f"    ğŸ“‹ å‘ç° {len(service_vulnerabilities)} ä¸ª {service_name} æœåŠ¡Pythonä¾èµ–æ¼æ´")
                            except Exception as e:
                                print(f"    âš ï¸ {service_name}æœåŠ¡Pythonä¾èµ–æ‰«æå¤±è´¥: {e}")

            return vulnerabilities

        def scan_secrets():
            """æ‰«æä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯"""
            print("ğŸ” æ‰«æä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯...")

            secrets = []

            # ä½¿ç”¨ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼æ‰«æ
            import re

            secret_patterns = [
                  (r'password\s*=\s*["\'][^"\'\r\n]{8,}["\']', 'hardcoded_password'),
                  (r'api[_-]?key\s*=\s*["\'][^"\'\r\n]{20,}["\']', 'api_key'),
                  (r'secret[_-]?key\s*=\s*["\'][^"\'\r\n]{20,}["\']', 'secret_key'),
                  (r'token\s*=\s*["\'][^"\'\r\n]{20,}["\']', 'token'),
                  (r'-----BEGIN [A-Z ]+-----', 'private_key')
              ]

            for root, dirs, files in os.walk('.'):
                # è·³è¿‡ä¸éœ€è¦æ‰«æçš„ç›®å½•
                dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['node_modules', '__pycache__', 'dist', 'build']]

                for file in files:
                    if file.endswith(('.py', '.js', '.ts', '.jsx', '.tsx', '.env', '.yaml', '.yml')):
                        file_path = os.path.join(root, file)
                        try:
                            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                                content = f.read()

                                for pattern, secret_type in secret_patterns:
                                    matches = re.finditer(pattern, content, re.IGNORECASE)
                                    for match in matches:
                                        secrets.append({
                                            'file': file_path,
                                            'type': secret_type,
                                            'line': content[:match.start()].count('\n') + 1,
                                            'match': match.group()[:50] + '...' if len(match.group()) > 50 else match.group()
                                        })
                        except Exception as e:
                            continue

            return secrets

        def main():
            environment = os.environ.get('ENVIRONMENT', 'staging')

            print(f"ğŸ”’ å¼€å§‹ {environment} ç¯å¢ƒå®‰å…¨æ‰«æ...")

            # æ‰«æç»“æœ
            scan_results = {
                'environment': environment,
                'docker_vulnerabilities': [],
                'dependency_vulnerabilities': [],
                'secrets': []
            }

            # æ‰«æDockeré•œåƒ
            try:
                scan_results['docker_vulnerabilities'] = scan_docker_images()
            except Exception as e:
                print(f"âŒ Dockeré•œåƒæ‰«æå¤±è´¥: {e}")

            # æ‰«æä¾èµ–åŒ…
            try:
                scan_results['dependency_vulnerabilities'] = scan_dependencies()
            except Exception as e:
                print(f"âŒ ä¾èµ–åŒ…æ‰«æå¤±è´¥: {e}")

            # æ‰«ææ•æ„Ÿä¿¡æ¯
            try:
                scan_results['secrets'] = scan_secrets()
            except Exception as e:
                print(f"âŒ æ•æ„Ÿä¿¡æ¯æ‰«æå¤±è´¥: {e}")

            # ä¿å­˜æ‰«æç»“æœ
            os.makedirs('security-reports', exist_ok=True)
            report_file = f'security-reports/{environment}-security-scan.json'

            with open(report_file, 'w') as f:
                json.dump(scan_results, f, indent=2)

            print(f"ğŸ“ å®‰å…¨æ‰«ææŠ¥å‘Šå·²ä¿å­˜åˆ° {report_file}")

            # è¾“å‡ºæ‘˜è¦
            docker_high_critical = len([v for v in scan_results['docker_vulnerabilities'] if v.get('Severity') in ['HIGH', 'CRITICAL']])
            dep_high_critical = len([v for v in scan_results['dependency_vulnerabilities'] if v.get('severity') in ['high', 'critical']])
            secrets_count = len(scan_results['secrets'])

            print(f"\nğŸ“Š å®‰å…¨æ‰«ææ‘˜è¦:")
            print(f"  Dockeré«˜å±æ¼æ´: {docker_high_critical}")
            print(f"  ä¾èµ–åŒ…é«˜å±æ¼æ´: {dep_high_critical}")
            print(f"  æ•æ„Ÿä¿¡æ¯æ³„éœ²: {secrets_count}")

            # æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡æ€§å®‰å…¨é—®é¢˜
            if docker_high_critical > 10 or dep_high_critical > 5 or secrets_count > 0:
                print(f"\nâŒ å‘ç°ä¸¥é‡å®‰å…¨é—®é¢˜ï¼Œå»ºè®®ä¿®å¤åå†éƒ¨ç½²")
                if environment == 'production':
                    print(f"ğŸš« ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¢«é˜»æ­¢")
                    sys.exit(1)
                else:
                    print(f"âš ï¸ æµ‹è¯•ç¯å¢ƒå…è®¸éƒ¨ç½²ï¼Œä½†è¯·å°½å¿«ä¿®å¤")
            else:
                print(f"\nâœ… å®‰å…¨æ‰«æé€šè¿‡")

        if __name__ == '__main__':
            main()
        EOF

        # å®‰è£…å®‰å…¨æ‰«æå·¥å…·
        pip install pip-audit

        # è¿è¡Œå®‰å…¨æ‰«æ
        python security-scan.py

    - name: éƒ¨ç½²å°±ç»ªæ£€æŸ¥
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        echo "âœ… è¿è¡Œ $ENVIRONMENT ç¯å¢ƒéƒ¨ç½²å°±ç»ªæ£€æŸ¥..."

        # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
        required_vars=()

        if [ "$ENVIRONMENT" = "production" ]; then
          required_vars=("PROD_DB_HOST" "PROD_REDIS_HOST" "PROD_SECRET_KEY")
        else
          required_vars=("STAGING_DB_HOST" "STAGING_REDIS_HOST" "STAGING_SECRET_KEY")
        fi

        missing_vars=()
        for var in "${required_vars[@]}"; do
          if [ -z "${!var}" ]; then
            missing_vars+=("$var")
          fi
        done

        if [ ${#missing_vars[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: ${missing_vars[*]}"
          echo "deployment_ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€ï¼ˆå¦‚æœæ˜¯stagingç¯å¢ƒï¼‰
        if [ "$ENVIRONMENT" = "staging" ]; then
          echo "ğŸ¥ æ£€æŸ¥stagingç¯å¢ƒæœåŠ¡å¥åº·çŠ¶æ€..."

          # è¿™é‡Œå¯ä»¥æ·»åŠ å¯¹stagingç¯å¢ƒçš„å¥åº·æ£€æŸ¥
          # curl -f https://staging.example.com/health || exit 1
        fi

        echo "deployment_ready=true" >> $GITHUB_OUTPUT
      id: deployment

    - name: è®¾ç½®éƒ¨ç½²URL
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        if [ "$ENVIRONMENT" = "production" ]; then
          echo "url=https://phoenixcoder.com" >> $GITHUB_OUTPUT
        else
          echo "url=https://staging.phoenixcoder.com" >> $GITHUB_OUTPUT
        fi
      id: deploy-url

    - name: ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-${{ matrix.environment }}
        path: security-reports/

    - name: é€šçŸ¥éƒ¨ç½²çŠ¶æ€
      env:
        ENVIRONMENT: ${{ matrix.environment }}
        DEPLOYMENT_READY: ${{ steps.deployment.outputs.deployment_ready }}
        DEPLOY_URL: ${{ steps.deploy-url.outputs.url }}
      run: |
        if [ "$DEPLOYMENT_READY" = "true" ]; then
          echo "ğŸš€ $ENVIRONMENT ç¯å¢ƒå·²å‡†å¤‡å¥½éƒ¨ç½²"
          echo "ğŸ“ éƒ¨ç½²åœ°å€: $DEPLOY_URL"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šè§¦å‘éƒ¨ç½²è„šæœ¬ã€è°ƒç”¨éƒ¨ç½²APIç­‰

          if [ "$ENVIRONMENT" = "production" ]; then
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‡†å¤‡å®Œæˆï¼"
          else
            echo "ğŸ§ª æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å‡†å¤‡å®Œæˆï¼"
          fi
        else
          echo "âŒ $ENVIRONMENT ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
