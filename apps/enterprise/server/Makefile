# PhoenixCoder æœåŠ¡å™¨ Makefile

.PHONY: help install test test-unit test-growth test-skills test-auth coverage lint format clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "PhoenixCoder æœåŠ¡å™¨å¼€å‘å·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install     - å®‰è£…ä¾èµ–"
	@echo "  test        - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-unit   - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-growth - è¿è¡Œæˆé•¿æ¨¡å—æµ‹è¯•"
	@echo "  test-skills - è¿è¡ŒæŠ€èƒ½æ¨¡å—æµ‹è¯•"
	@echo "  test-auth   - è¿è¡Œè®¤è¯æ¨¡å—æµ‹è¯•"
	@echo "  coverage    - ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  lint        - ä»£ç æ£€æŸ¥"
	@echo "  format      - ä»£ç æ ¼å¼åŒ–"
	@echo "  clean       - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  dev         - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
	pip install -r requirements.txt
	pip install -r requirements-test.txt

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	python run_tests.py

# è¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest tests/ -v -m unit

# è¿è¡Œæˆé•¿æ¨¡å—æµ‹è¯•
test-growth:
	@echo "ğŸ§ª è¿è¡Œæˆé•¿æ¨¡å—æµ‹è¯•..."
	pytest tests/test_growth_api.py -v

# è¿è¡ŒæŠ€èƒ½æ¨¡å—æµ‹è¯•
test-skills:
	@echo "ğŸ§ª è¿è¡ŒæŠ€èƒ½æ¨¡å—æµ‹è¯•..."
	pytest tests/test_skills_api.py -v

# è¿è¡Œè®¤è¯æ¨¡å—æµ‹è¯•
test-auth:
	@echo "ğŸ§ª è¿è¡Œè®¤è¯æ¨¡å—æµ‹è¯•..."
	pytest tests/test_auth_api.py -v

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
coverage:
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	pytest tests/ --cov=api --cov-report=html --cov-report=term-missing
	@echo "ğŸ“„ HTMLæŠ¥å‘Šå·²ç”Ÿæˆåˆ° htmlcov/ ç›®å½•"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	flake8 api/ tests/
	black --check api/ tests/
	isort --check-only api/ tests/

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "âœ¨ ä»£ç æ ¼å¼åŒ–..."
	black api/ tests/
	isort api/ tests/

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	uvicorn main:app --reload --host 0.0.0.0 --port 8000

# å¿«é€Ÿæµ‹è¯•ï¼ˆä»…è¿è¡Œå¤±è´¥çš„æµ‹è¯•ï¼‰
test-fast:
	@echo "âš¡ å¿«é€Ÿæµ‹è¯•..."
	pytest tests/ -v --lf --tb=short

# æµ‹è¯•ç‰¹å®šæ–‡ä»¶
test-file:
	@echo "ğŸ¯ æµ‹è¯•æŒ‡å®šæ–‡ä»¶..."
	@read -p "è¯·è¾“å…¥æµ‹è¯•æ–‡ä»¶è·¯å¾„: " file; \
	pytest $$file -v

# å®‰è£…pre-commité’©å­
install-hooks:
	@echo "ğŸª å®‰è£…pre-commité’©å­..."
	pip install pre-commit
	pre-commit install

# è¿è¡Œç±»å‹æ£€æŸ¥
typecheck:
	@echo "ğŸ” ç±»å‹æ£€æŸ¥..."
	mypy api/ --ignore-missing-imports